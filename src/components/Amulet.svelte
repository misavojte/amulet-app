<script lang="ts">
    import { gameState } from '../stores/GameState';
    export let length: number = 50;  
    export let bottomColor: string = '#896c89';
    export let sideAColor: string = '#b572b5';
    export let sideBColor: string = '#b572b5';
    export let sideCColor: string = '#b572b5';
    export let sideDColor: string = '#b572b5';
    export let topColor: string = '#d995d9';
    export let xRotation: number = 30;
    export let zRotation: number = 0;

    let hasAmulet: boolean;
    let hoverExtra: boolean = false;

    $ : hoverExtra = hasAmulet;

    gameState.subscribe(value => {
        if (!value) throw new Error('Game state is not set');
        hasAmulet = value.hasAmulet;
    });

    let xLength = length;
    let zLength = length/10;
    let yLength = length;

    const evaluateTransition = (e: TransitionEvent) => {
        if (e.target === e.currentTarget) {
            if (hasAmulet) {
                hoverExtra = !hoverExtra;
                return;
            }
            hoverExtra = false;
        }
    }

    let cssVarStyles = `--xLength:${xLength}px;--zLength:${zLength}px;--yLength:${yLength}px;--bottomColor:${bottomColor};--sideAColor:${sideAColor};--sideBColor:${sideBColor};--sideCColor:${sideCColor};--sideDColor:${sideDColor};--topColor:${topColor};`;

</script>

<div class="main" style={cssVarStyles} on:click>
    <div class="moving-part" class:hover={hasAmulet}>
    <div class="animating-part" class:animate={hoverExtra} on:transitionend={evaluateTransition}>
        <div class="box">
            <div class="bottom"></div>
            <div class="side-a"></div>
            <div class="side-b"></div>
            <div class="side-c"></div>
            <div class="side-d"></div>
            <div class="top"></div>
        </div>
        <div class="box">
            <div class="bottom"></div>
            <div class="side-a"></div>
            <div class="side-b"></div>
            <div class="side-c"></div>
            <div class="side-d"></div>
            <div class="top"></div>
        </div>
        <div class="star-top">
            <svg xmlns="http://www.w3.org/2000/svg" width="100" viewBox="0 0 75 75" height="100" version="1.0">
                <g class="inner"><path fill="#b572b5" d="M42.945 54.254v-.59h-.222v-4.07l-4.91-.035-.012-22.504h1.277v-.59h-1.277v-.633h1.285v-.59H37.8v-.629h1.297v-.59h-1.301v-1.57h3.016v-3.488h-.59v2.902h-2.426v-2.902h-.59v2.902h-2.41v-2.902h-.59v3.488h3v1.57h-1.281v.59h1.285v.63h-1.297v.589h1.297v.633h-1.305v.59h1.305l.012 22.5-4.332-.035v-.004h-.59v4.148h-.235v.59h.235v1.18h-.235v.59h1.059v-.59h-.234v-1.18h.234v-.59h-.234V50.11l.304.004v.602h.59v-.598l3.438.028v1.398h-2.22v2.867h.59v-2.277h1.63l.004 3.3h-.247v.59h1.063v-.59h-.227l-.004-3.3h1.614v2.277h.59v-2.867h-2.203v-1.395l3.484.028v.539h.59v-.535h.242v3.484h-.242v.59h.242v1.18h-.242v.59h1.058v-.59h-.222v-1.18h.222" />
                <path fill="#b572b5" d="M25.082 25.684a.697.697 0 0 1-.637-.977l.918.918a.738.738 0 0 1-.281.059Zm.695-.696a.63.63 0 0 1-.027.192l-.86-.86a.694.694 0 0 1 .887.668Zm26.668 23.457.422-.41-2.441-2.492-.422.414-1.742 1.707-1.11-1.105.95-.934-.414-.422-.954.938-.445-.446.965-.949-.414-.422-.969.953-.445-.445.98-.965-.414-.418-.984.965-15.102-15.086a2.637 2.637 0 0 1 3.504.195l.418-.414a3.203 3.203 0 0 0-2.281-.945c-.762 0-1.485.262-2.063.746l-.773-.773 2.816-2.817-.418-.414-3.562-3.562-.414.418 3.558 3.558-2.398 2.399-1.168-1.168.906-.906-.418-.415-.906.907-.508-.512a1.284 1.284 0 0 0-1.117-1.922 1.286 1.286 0 0 0 0 2.57c.266 0 .508-.082.711-.218l.496.496-.918.922.418.418.918-.922 1.172 1.168-2.418 2.418-3.559-3.563-.418.418 3.977 3.977 2.832-2.832.777.773a3.183 3.183 0 0 0-.746 2.059 3.2 3.2 0 0 0 .946 2.281l.418-.418a2.637 2.637 0 0 1-.2-3.504l15.098 15.082-.86.84.415.422.863-.848.445.45-.875.855.414.422.88-.864.444.45-.886.87.41.423.894-.88 1.11 1.11-1.711 1.676-.422.414 2.445 2.492.422-.414-2.031-2.07 1.715-1.68 2.047 2.043.418-.418-2.043-2.039 1.738-1.707 2.027 2.07" />
                <path fill="#b572b5" d="m52.965 37.625 2.918-.004v-.59l-2.918.004v-2.422h2.898v-.59h-3.488v3.012h-2.977a2.64 2.64 0 0 1 2.625-2.422v-.59a3.225 3.225 0 0 0-3.214 3.012h-.762v-1.273h-.59v1.273l-.77.004a3.23 3.23 0 0 0-3.21-2.926v.59a2.638 2.638 0 0 1 2.617 2.336l-23.496.012v-6.035h-3.493v.59h2.903v2.417h-2.903v.59h2.903v2.418h-2.903v.59h.016v.02h2.887v2.398h-2.903v.59h2.903v2.418h-2.903v.59h3.493V37.64l23.496-.012a2.636 2.636 0 0 1-2.617 2.344v.59a3.23 3.23 0 0 0 3.21-2.934h.77v1.305h.59v-1.309h.777a3.227 3.227 0 0 0 3.2 2.848v-.59a2.638 2.638 0 0 1-2.606-2.258h2.957v3.004h3.488v-.59h-2.898v-2.414" />
                <path fill="#b572b5" d="m52.805 26.695-.418-.418-2.047 2.051-1.715-1.715 2.066-2.07-.414-.414-2.07 2.07-1.707-1.71 2.05-2.048-.413-.418-2.469 2.465 2.125 2.125-1.211 1.211a2.63 2.63 0 0 1-.57-2.281l-.575-.129a3.214 3.214 0 0 0 .727 2.828l-.453.453a3.23 3.23 0 0 0-4.348.192l.414.418a2.635 2.635 0 0 1 3.516-.188l-14.11 14.125a2.637 2.637 0 0 1 .274-3.402l-.418-.418a3.197 3.197 0 0 0-.941 2.277c0 .719.23 1.403.664 1.965l-1.117 1.117-.907-.906-.418.418.907.906-.895.899-2.086-2.09-3.98 3.976.418.418 3.562-3.558 1.668 1.668-.469.468-.906-.906-.414.418.906.906-.449.446-.91-.91-.418.414.914.914-.45.449-.917-.922-.418.418.922.918-1.012 1.012.418.418 1.008-1.012.906.906.418-.418-.906-.906.445-.445.914.914.418-.418-.914-.914.445-.446.922.918.418-.414-.922-.922.469-.468 1.75 1.75-3.562 3.558.418.418 3.976-3.976-2.164-2.168.895-.899.921.922.414-.418-.918-.918 1.098-1.101a3.21 3.21 0 0 0 2.16.828c.86 0 1.672-.336 2.278-.946l-.414-.417a2.64 2.64 0 0 1-3.606.117l14.129-14.145a2.64 2.64 0 0 1-.203 3.496l.418.414c.605-.61.941-1.418.941-2.277 0-.758-.258-1.477-.734-2.055l.465-.465a3.212 3.212 0 0 0 3.203.454l-.219-.547a2.629 2.629 0 0 1-2.566-.328l1.195-1.196 2.133 2.13 2.465-2.466" />
                <path fill="#b572b5" d="M43.637 29.691a.39.39 0 0 0-.387-.386.391.391 0 0 0-.39.386.388.388 0 0 0 .777 0m2.078 1.914a.39.39 0 0 0-.387-.386.388.388 0 0 0 0 .773.388.388 0 0 0 .387-.387" />
                </g>
                <g class="outer">
                  <path fill="#b572b5" d="M37.496 7.777c-16.387 0-29.719 13.332-29.719 29.72 0 16.386 13.332 29.714 29.72 29.714 16.386 0 29.718-13.328 29.718-29.715S53.883 7.777 37.496 7.777Zm0 59.973c-8.082 0-15.684-3.145-21.394-8.86-5.715-5.714-8.864-13.312-8.864-21.394 0-8.082 3.149-15.684 8.864-21.398 5.71-5.715 13.312-8.86 21.394-8.86 8.082 0 15.68 3.145 21.395 8.86 5.714 5.715 8.863 13.316 8.863 21.398 0 8.082-3.149 15.68-8.863 21.395-5.715 5.714-13.313 8.859-21.395 8.859" />
                <path fill="#b572b5" d="M37.457 17.379c-11.09 0-20.113 9.023-20.113 20.117 0 11.09 9.023 20.113 20.113 20.113 11.094 0 20.117-9.023 20.117-20.113 0-11.094-9.023-20.117-20.117-20.117Zm0 40.77c-11.387 0-20.652-9.266-20.652-20.653 0-11.39 9.265-20.656 20.652-20.656 11.39 0 20.656 9.265 20.656 20.656 0 11.387-9.265 20.652-20.656 20.652M38.5 15.602a.264.264 0 0 1-.25-.176L36.094 9.68a.269.269 0 0 1 .156-.348.27.27 0 0 1 .348.156l2.156 5.746a.27.27 0 0 1-.16.348.269.269 0 0 1-.094.02" />
                <path fill="#b572b5" d="M36.352 15.602a.27.27 0 0 1-.254-.363l2.144-5.75a.27.27 0 0 1 .348-.16c.14.054.21.206.156.347l-2.144 5.75a.264.264 0 0 1-.25.176m-13.489-1.977 1.106 2.113 1.066-2.113Zm2.164 5.293L22.18 13.48a.279.279 0 0 1 .008-.265.268.268 0 0 1 .23-.13h3.055a.269.269 0 0 1 .242.392l-1.285 2.55 3.273 1.45-.219.492-3.054-1.352 1.074 2.051-.477.25m4.442-4.82-.465-.274 2.504-4.254.465.274-2.504 4.254" />
                <path fill="#b572b5" d="m33.105 16.695-4.07-2.797.305-.441 4.07 2.793-.305.445M21.14 23.54l-4.527-4.56a.264.264 0 0 1-.07-.253c.023-.09.09-.16.18-.192l2.945-.945.164.512-2.527.812 4.215 4.246-.38.38" />
                <path fill="#b572b5" d="m18.422 20.594-.168-.512 2.316-.77.168.512-2.316.77m-.75 7.328-5.344-3.235.277-.46 5.344 3.234-.277.46" />
                <path fill="#b572b5" d="M16.086 26.484h-.54v-2.277l-1.515 1.297-.351-.41 1.96-1.68a.27.27 0 0 1 .446.207v2.863m.144 6.707-6.843-1.906a.269.269 0 0 1-.078-.484l2.64-1.754a.267.267 0 0 1 .219-.035l4.703 1.23-.137.52-4.586-1.2-2.05 1.364 6.277 1.746-.145.52m-.144 5.542H8.902v-.539h7.184v.54" />
                <path fill="#b572b5" d="m10.434 38.656-2.118-2.12.38-.38 2.12 2.117-.382.383m1.203-.023-1.723-2.117.418-.34 1.723 2.117-.418.34m-.856 4.523 2.356.332 1.8-1.48Zm2.516.899-1.55 1.273 3.694-.973Zm-2.672 2.12a.267.267 0 0 1-.238-.148.27.27 0 0 1 .066-.332l2.121-1.742-3.156-.445a.267.267 0 0 1-.23-.25.273.273 0 0 1 .199-.278l6.625-1.828a.269.269 0 0 1 .246.465l-2.395 1.973 2.977.418a.27.27 0 0 1 .234.25.27.27 0 0 1-.203.277l-6.176 1.63a.221.221 0 0 1-.07.01m2.309 5.645 2.53.121.868-2.226-2.305-.207Zm2.71.672h-.011l-3.13-.152a.266.266 0 0 1-.23-.383l1.348-2.848a.28.28 0 0 1 .27-.156l2.644.238.88-2.254.503.196-.82 2.105 2.847.254-.047.54-3.007-.27-.993 2.558a.277.277 0 0 1-.253.172m1.863 4.961h2.191v-2.191h-2.191Zm2.46.54h-2.73a.27.27 0 0 1-.27-.27v-2.73a.27.27 0 0 1 .27-.27h2.73a.27.27 0 0 1 .27.27v2.73a.27.27 0 0 1-.27.27m4.242 5.827-1.144-2.054.473-.262.656 1.176 3.157-6.09.48.246-3.621 6.984m4.399 1.422a.27.27 0 0 1-.184-.07.268.268 0 0 1-.07-.281l2.206-6.825.512.168-2.031 6.274 2.816-1.149.203.5-3.351 1.364a.225.225 0 0 1-.102.02" />
                <path fill="#b572b5" d="M31.344 66.055a.267.267 0 0 1-.223-.118l-2.02-3 .446-.3 1.7 2.52 1.812-6.344.515.152-1.969 6.894a.275.275 0 0 1-.218.192c-.016.004-.028.004-.043.004m4.668.664a.227.227 0 0 1-.075-.012.285.285 0 0 1-.214-.277l.011-7.293.57.004-.007 6.191.754-1.348a.292.292 0 0 1 .25-.148.29.29 0 0 1 .25.148l.758 1.348v-6.195h.57v7.293a.28.28 0 0 1-.215.277.281.281 0 0 1-.32-.137L37.3 64.71l-1.043 1.86a.278.278 0 0 1-.246.149m6.446-6.106 1.922.375-.524-2.222Zm1.043 3.043 1.953.813-.805-2.465Zm2.422 1.606a.294.294 0 0 1-.113-.024l-2.856-1.187a.284.284 0 0 1-.164-.184.275.275 0 0 1 .04-.246l1.437-2.074-2.371-.457a.286.286 0 0 1-.172-.457l1.965-2.59-.032-.133.559-.133.875 3.743 1.101 3.367a.282.282 0 0 1-.078.297.272.272 0 0 1-.191.078m6.086-2.637a.347.347 0 0 1-.059-.008l-2.054-.43.12-.562 1.391.293-3.597-5.68.484-.304 3.957 6.25a.283.283 0 0 1-.004.316.293.293 0 0 1-.238.125" />
                <path fill="#b572b5" d="M51.977 62.645a.282.282 0 0 1-.243-.137l-3.894-6.293.488-.3 3.535 5.714.344-1.379.559.14-.512 2.036a.284.284 0 0 1-.23.215c-.016 0-.032.004-.047.004m4.898-3.435h-.57v-4.546l-2.11 1.906a.293.293 0 0 1-.3.055.286.286 0 0 1-.176-.25l-.27-5.355.57-.032.239 4.754 2.14-1.937a.287.287 0 0 1 .477.215v5.19m5.43-7.19-6.457-3.875.297-.493 6.453 3.875-.293.493" />
                <path fill="#b572b5" d="m60.71 53.16-.733-2.629a.286.286 0 0 1 .25-.363l2.996-.297.054.57-2.656.266.64 2.3-.55.153m3.613-6.75-.793-1.61a.29.29 0 0 1 .121-.378l1.399-.762-6.223-1.793.531 1.074a.29.29 0 0 1-.117.38l-1.637.894-.277-.504 1.395-.762-.696-1.414a.28.28 0 0 1 .04-.308.292.292 0 0 1 .296-.094l7.516 2.172a.284.284 0 0 1 .207.246.288.288 0 0 1-.148.281l-1.77.961.668 1.367-.512.25m1.242-7.246-.492-.285.692-1.2-7.45.337a.287.287 0 0 1-.254-.445l1.153-1.759.476.313-.843 1.293 7.418-.336a.286.286 0 0 1 .261.43l-.96 1.652m-6.587-6.238-.527-.23 1.324-3.063a.288.288 0 0 1 .368-.153l2.14.825-.207.53-1.883-.722-1.215 2.813" />
                <path fill="#b572b5" d="M62.59 32.742a.252.252 0 0 1-.106-.02l-2.136-.82.203-.535 1.883.723 1.214-2.809.528.227-1.324 3.062a.283.283 0 0 1-.262.172M52.516 22.445l-.375-.433 5.285-4.543.37.433-5.28 4.543" />
                <path fill="#b572b5" d="m55.797 21.707-.57-.078.609-4.637.57.074-.61 4.641m-8.362-3.184-.504-.277 3.285-5.95.504.278-3.285 5.95m2.195 1.035-.504-.278 3.29-5.949.5.277-3.286 5.95" />
                <path fill="#b572b5" d="M50.441 17.781a.284.284 0 0 1-.28-.226l-.759-3.637a.286.286 0 1 1 .559-.117l.758 3.636a.286.286 0 0 1-.219.34c-.02.004-.04.004-.059.004m-6.151-7.527-.536 1.754 2.074-.418Zm-1.727 5.68-.551-.168 1.86-6.102a.285.285 0 0 1 .46-.133l2.309 2.008a.29.29 0 0 1-.13.5l-2.945.59-1.004 3.305M56.25 26.96l-.258-.51 6.059-3.087.261.512-6.062 3.086m-21.187 9.152a2.769 2.769 0 0 0 1.011 3.778 2.773 2.773 0 0 0 3.781-1.012 2.774 2.774 0 0 0-1.011-3.781 2.762 2.762 0 0 0-2.102-.274 2.748 2.748 0 0 0-1.68 1.29Zm2.39 4.684c-.558 0-1.129-.14-1.648-.442a3.305 3.305 0 0 1-1.207-4.511 3.286 3.286 0 0 1 2.007-1.543 3.294 3.294 0 0 1 2.508.332 3.31 3.31 0 0 1 1.207 4.515 3.3 3.3 0 0 1-2.867 1.649M34.656 12.8a.624.624 0 1 1-1.245-.005.624.624 0 0 1 1.245.006m6.489.113a.622.622 0 1 1-1.204-.32.622.622 0 0 1 1.204.32m6.234 1.793a.62.62 0 0 1-.852.227.622.622 0 1 1 .852-.227m5.562 3.343a.622.622 0 1 1-.884-.879.622.622 0 0 1 .884.88m4.504 4.672a.626.626 0 0 1-.625-1.082.624.624 0 0 1 .625 1.082m3.141 5.675a.625.625 0 0 1-.32-1.207.625.625 0 0 1 .32 1.207m1.566 6.293a.624.624 0 1 1 .005-1.245.624.624 0 0 1-.005 1.245m-.112 6.489a.622.622 0 1 1 .32-1.204.622.622 0 0 1-.32 1.204m-1.794 6.238a.621.621 0 0 1-.226-.852.621.621 0 1 1 1.078.621.622.622 0 0 1-.852.231m-3.344 5.559a.627.627 0 0 1 0-.883.627.627 0 0 1 .883 0 .627.627 0 0 1 0 .883.627.627 0 0 1-.883 0m-4.668 4.503a.621.621 0 0 1 .227-.851.624.624 0 1 1 .621 1.082.621.621 0 0 1-.848-.23m-5.679 3.144a.628.628 0 0 1 .441-.766.624.624 0 1 1 .324 1.203.624.624 0 0 1-.765-.437m-6.293 1.566c0-.347.277-.625.62-.625a.624.624 0 1 1-.621.625m-6.488-.117a.622.622 0 1 1 1.203.32.622.622 0 0 1-1.203-.32m-6.238-1.793a.624.624 0 1 1 1.085.625.624.624 0 0 1-1.085-.625m-5.558-3.343a.627.627 0 0 1 .882 0 .627.627 0 0 1 0 .882.627.627 0 0 1-.882 0 .627.627 0 0 1 0-.883m-4.504-4.667a.624.624 0 0 1 .851.226.624.624 0 1 1-.852-.227m-3.14-5.675a.62.62 0 0 1 .762.437.622.622 0 1 1-.762-.438m-1.566-6.296a.624.624 0 1 1-.005 1.245.624.624 0 0 1 .005-1.245m.113-6.488c.332.09.531.43.441.765a.62.62 0 0 1-.761.438.622.622 0 1 1 .32-1.203m1.793-6.235a.624.624 0 1 1-.626 1.079.624.624 0 0 1 .626-1.079m3.344-5.562a.627.627 0 0 1 0 .883.627.627 0 0 1-.883 0 .627.627 0 0 1 0-.883.627.627 0 0 1 .883 0m4.668-4.504c.175.3.07.68-.227.851a.621.621 0 1 1-.621-1.078.62.62 0 0 1 .848.227m5.679-3.141a.625.625 0 0 1-1.207.32.625.625 0 0 1 1.207-.32" />
                  </g>
              </svg>
        </div>
    </div>
    </div>
    <div class="shadow">
        <div></div>
    </div>
</div>

<style>
    div {
        transform-style: preserve-3d;
    }
    
    .box:first-child {
        transform: rotateZ(45deg);
    }

    .box {
        position: absolute;
        margin: 0 auto;
        transform-style: preserve-3d;
        width: var(--xLength);
        height: var(--yLength);
        cursor: pointer;
    }

    .bottom, .top {
        position: absolute;
        width: var(--xLength);
        height: var(--yLength);
    }

    .bottom {
        background: var(--bottomColor); 
    }

    .side-a, .side-c {
        position: absolute;
        width: var(--xLength);
        height: var(--zLength);
    }

    .side-a {   
        background: var(--sideAColor);
        transform-origin: bottom;
        transform: rotateX(-90deg);
        bottom: 0;
    }

    .side-b, .side-d {
        position: absolute;
        width: var(--zLength);
        height: var(--yLength);
    }

    .side-b {
        background: var(--sideBColor);
        transform-origin: right;
        transform: rotateY(90deg);
        right: 0;
    }

    .side-c {
        background: var(--sideCColor);
        transform-origin: top;
        transform: rotateX(90deg);
        top: 0;
    }

    .side-d {
        background: var(--sideDColor);
        transform-origin: left;
        transform: rotateY(-90deg);
        left: 0;
    }

    .top {
        transform: translateZ( var(--zLength));
        background: var(--topColor);
        transition: transform 1s;
        position: relative;
        transform-style: preserve-3d;
        transform-origin: top;
    }
    .star-top {
        position: absolute;
        top: 0;
        left: 0;
        width: var(--xLength);
        height: var(--yLength);
        background: var(--topColor);
        transform: translateZ(calc(var(--zLength) + 1px));
        transform-origin: top;
        transition: transform 1s;
        transform-style: preserve-3d;
        box-sizing: border-box;
    }
    .star-top svg {
        width: 100%;
        height: 100%;
    }

    path {
        transition: all 0.05s;
        transition-delay: 0.15s;
    }

    g.outer path {
        transition-delay: 0.3s;
    }

    .main {
        width: var(--xLength);
        height: var(--yLength); 
        cursor: pointer;
    }

    svg {
        pointer-events: none;
    }

    .moving-part.hover svg path, .moving-part:hover svg path {
        filter: drop-shadow(0 0 10px #e7eef3);
        fill: #e7eef3;
    }

    .moving-part {
        transition: 1s ease-in-out all;
        transform: translateZ(0);
    }

    .moving-part.hover {
        transform: translateZ(35px);
    }

    .animating-part {
        transition: transform 1s ease-in-out;
    }

    .animating-part.animate {
        transform: translateZ(10px);
    }


    .shadow {
        position: absolute;
        width: var(--xLength);
        height: var(--yLength);
        background: rgba(0,0,0,0.5);
        filter: blur(10px); 
    }


    @keyframes moving {
        0% {
            transform: translateZ(0px);
        }
        50% {
            transform: translateZ(10px);
        }
        100% {
            transform: translateZ(0px);
        }
    }
</style>